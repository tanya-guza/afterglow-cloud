{% extends "base.html" %}

{% block title %}
	Rendered Graph - Afterglow
{% endblock %}

{% block extra_head %}
    <script src="{{ STATIC_URL }}js/render.js" type="text/javascript"></script>
    <script src="{{ STATIC_URL }}js/helios/lib/q.min.js"></script>
    <script src="{{ STATIC_URL }}js/helios/lib/uuid.js"></script>
    <script src="{{ STATIC_URL }}js/helios/lib/q-comm.js"></script>
    <script src="{{ STATIC_URL }}js/helios/helios.js"></script>
    <script src="{{ STATIC_URL }}js/d3.v3.js" ></script>
    <script src="{{ STATIC_URL }}js/force-graphson-facade.js" ></script>
{% endblock %}

{% block body %}

	{% if retVal %}

		<center>
		<div class="cRenderError">
		<span class="cErrorMsg">

		{% ifequal retVal 1 %}
				Error: An invalid regular expression has been input which does not match one or more lines in the given file.
		{% endifequal %}

		{% ifequal retVal 2 %}
				Error: An invalid regular expression has been input which does not generate the required groupings for the file given to parse. If your expression has three groups, three columns will be attempted to be written.
		{% endifequal %}

		<br/><br/>
		Please try <a href="process" title="Back">again</a>.

		</span>
		</div>
		</center>

	{% elif emptyData %}
		<center>
			<span id="error">
				Your search returned no data for AfterGlow to parse. Please try again.
			</span>
			<a href="/search">Try Again</a>
		</center>
	{% else %}

		{% if not status %}

			{% if form.errors %}
				<div class="errorMsg">
					Please correct the error{{ form.errors|pluralize }} below.
				</div>
			{% endif %}

			<center>
				<a href="#" id="galleryFormLink" alt="">Submit your image to the gallery!</a>
			</center>

			<br/><br/>

			<form enctype="multipart/form-data" method="post" action="gallery-submit" id="gallerySubmitForm">
				{% csrf_token %}

				<div class="field">
					{{ form.name.errors }}
					<label>Name:</label>
					{{ form.name }}
				</div>

				<div class="field">
					{{ form.description.errors }}
					<label>Description:</label>
					{{ form.description }}
				</div>

				<div class="field">
					{{ form.author.errors }}
					<label>Author:</label>
					{{ form.author }}
				</div>

				<div class="field">
					<label>&nbsp;</label>
					<script type="text/javascript" src="http://api.recaptcha.net/challenge?k={{ CAPTCHA_PUBLIC_KEY }}"></script>
				</div>

				<noscript>
					<iframe src="http://api.recaptcha.net/noscript?k={{ CAPTCHA_PUBLIC_KEY }}" height="300" width="500" frameborder="0"></iframe>
					<br/>
					<textarea name="recaptcha_challenge_field" rows="3" cols="40">
					</textarea>
					<input type="hidden" name="recaptcha_response_field" value="manual_challenge">
				</noscript>

				{% if captchaWrong %}
					<div class="errorMsg">
						Your captcha input is wrong. Please try again.
					</div>
				{% endif %}

				{{ form.image }}


				<input type="submit" value="Submit" id="xContactProcess">
			</form>

			<br/><br/>

			<b>Rendered Graph</b>:
            <script type="text/javascript">
                var g = new Helios.GraphDatabase({'heliosDBPath' : '{{ STATIC_URL }}js/helios/lib/heliosDB.js',
                'vertices' : {}, 'edges' : {}, 'v_idx' : {}, 'e_idx' : {}});
g.loadGraphSON('{{ STATIC_URL }}rendered/{{ requestID }}.json');


                g.E().then(function(edges){
                    g.V().then(function(vertices){
                          var graph = d3.graphson.facade(edges, vertices);
                        console.log(graph);
                          force
                              .nodes(graph.vertices)
                              .links(graph.edges)
                                  .start();


                        var link = svg.selectAll(".link")
                                .data(graph.edges)
                                .enter().append("line")
                                .attr("class", "link");

                        var node = svg.selectAll(".node")
                                .data(graph.vertices)
                                .enter().append("circle")
                                .attr("class", "node")
                                .attr("r", 5)
                                .call(force.drag);

                        node.append("title")
                                .text(function(d) { return d._label; });

                          node.append("text")
                              .attr("dx", 12)
                              .attr("dy", ".35em")
                              .text(function(d) { return d._label; });

                        force.on("tick", function() {
                            link.attr("x1", function(d) { return d.source.x; })
                                    .attr("y1", function(d) { return d.source.y; })
                                    .attr("x2", function(d) { return d.target.x; })
                                    .attr("y2", function(d) { return d.target.y; });

                            node.attr("cx", function(d) { return d.x; })
                                    .attr("cy", function(d) { return d.y; });
                        });
                    });
                });


                var width = 960, height = 500;

                var color = d3.scale.category20();

                var force = d3.layout.force()
                        .charge(-120)
                        .linkDistance(30)
                        .size([width, height]);

                var svg = d3.select("body").append("svg")
                    .attr("width", width)
                    .attr("height", height);


            </script>

		{% else %}

			<center>
			<div class="cRenderError"><span class="cErrorMsg">

			{% ifequal status 1 %}
				Error: Could not create an output image (1).
			{% endifequal %}

			{% ifequal status 2 %}
		    Error: Data file does not exist (2).
		{% endifequal %}

		{% ifequal status 3 %}
		    Error: Property file does not exist (3).
		{% endifequal %}

		{% ifequal status 4 %}
		    Fatal: Perl is not installed. (4).
		{% endifequal %}

		{% ifequal status 5 %}
		    Fatal: GraphViz (neato/sfdp/dot) is not installed (5).
		{% endifequal %}

		{% ifequal status 6 %}
		    Error: Could not find afterglow instance (6).
		{% endifequal %}

		</span></div></center>

	    {% endif %}

	{% endif %}

	{% if submitError %}
		<script>$('#gallerySubmitForm').show();</script>
	{% endif %}

{% endblock %}
